[Metadata]
Name=Fountain of Colors
Author=alatsombath
Version=03 March 2015
License=Creative Commons Attribution-Non-Commercial-Share Alike 3.0
Information=A music visualizer for Rainmeter

[Rainmeter]
Update=16

@Include=#@#Variables.inc

[MeasureAudio]
Measure=Plugin
Plugin=AudioLevel
Port=Output
FFTSize=#FFTSize#
FFTOverlap=(#FFTSize#/2)
FFTAttack=#FFTAttack#
FFTDecay=#FFTDecay#
Bands=#Bands#
FreqMin=#FreqMin#
FreqMax=#FreqMax#
Sensitivity=#Sensitivity#

[MeterBar]
X=#BarGapX#
Y=#BarGapY#
W=#BarWidth#
H=#BarHeight#
BarOrientation=#BarOrientation#

[ScriptRepeatBands]
Measure=Script
ScriptFile=#@#RepeatSection.lua
ReadFile=#@#ReadBands.inc
WriteFile=#@#WriteBands.inc
Sub=Repeat
Index=1
Limit=(#Bands#-1)
@Include=#@#WriteBands.inc

[ScriptColorChanger]
Measure=Script
ScriptFile=#@#ColorChanger.lua
Sub=Repeat
Index=1
Limit=(#Bands#-1)

[MeasureNowPlaying]
Measure=Plugin
Plugin=NowPlaying
PlayerName=#PlayerName#
PlayerType=COVER

[BandLimit]
Measure=Calc
Formula=0
IfEqualValue=0
IfEqualAction=[!SetVariable BandLim (#Bands#-1)]
UpdateDivider=-1

[MeterAlbumArt]
Meter=Image
ImageName=[MeasureNowPlaying]
DynamicVariables=1
PreserveAspectRatio=1
X=([MeterBar#BandLim#:X]-300)
Y=100%
W=300
H=300

[MeasureNowPlayingArtist]
Measure=Plugin
Plugin=NowPlaying
PlayerName=[MeasureNowPlaying]
PlayerType=ARTIST

[MeasureNowPlayingAlbum]
Measure=Plugin
Plugin=NowPlaying
PlayerName=[MeasureNowPlaying]
PlayerType=ALBUM

[MeasureNowPlayingTrack]
Measure=Plugin
Plugin=NowPlaying
PlayerName=[MeasureNowPlaying]
PlayerType=TITLE

[AlbumSearchTerm]
Measure=String
String=[MeasureNowPlayingArtist][MeasureNowPlayingAlbum]
DynamicVariables=1
Substitute=" ":"",",":"","'":"","&":"","(":"",")":""
IfMatch=^$
IfMatchAction=[!Log "No album info retrieved. Defaulting to RandomColorPlaylist" Warning][!CommandMeasure ScriptColorChanger """Playlist("RandomColorPlaylist")"""]
OnChangeAction=[!SetVariable NewAlbum [AlbumSearchTerm]][!UpdateMeasure AlbumArtModeCheck]

[AlbumArtModeCheck]
Measure=String
String=#ColorPlaylist#
DynamicVariables=1
IfMatch=AlbumArt
IfMatchMode=1
IfMatchAction=[!UpdateMeasure NewAlbumCheck]
UpdateDivider=-1

[NewAlbumCheck]
Measure=String
String=#CurrentAlbum#
DynamicVariables=1
IfMatch=#NewAlbum#
IfNotMatchAction=[!SetVariable CurrentAlbum #NewAlbum#][!UpdateMeasure NewAlbumCheck][!CommandMeasure MeasureParseImgSrc Update]
UpdateDivider=-1

[MeasureParseImgSrc]
Measure=Plugin
Plugin=WebParser
DynamicVariables=1
URL=http://[&AlbumSearchTerm].jpg.to/medium
RegExp=src="(.*)"
UpdateRate=9999999
OnConnectErrorAction=[!Log "No album info retrieved. Defaulting to RandomColorPlaylist" Warning][!CommandMeasure ScriptColorChanger """Playlist("RandomColorPlaylist")"""]

[MeasureParseImgColors]
Measure=Plugin
Plugin=WebParser
DynamicVariables=1
URL=http://mkweb.bcgsc.ca/color_summarizer/?text=1&url=[MeasureParseImgSrc]&precision=medium
StringIndex=1
Download=1
DownloadFile=[AlbumSearchTerm].txt
FinishAction=[!CommandMeasure ScriptColorChanger AlbumArt()]
OnConnectErrorAction=[!Log "No album info retrieved. Defaulting to RandomColorPlaylist" Warning][!CommandMeasure ScriptColorChanger """Playlist("RandomColorPlaylist")"""]